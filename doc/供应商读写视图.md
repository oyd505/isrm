# **读写视图**：供应商管理视图

> 使用[Vue3](https://cn.vuejs.org/guide/introduction.html) + [View UI Plus](https://www.iviewui.com/view-ui-plus/guide/introduce)

## **列表视图**

- **ListView.vue** 是列表视图，用于展示供应商列表，提供表格分页、排序等操作。

```vue
<script setup>
  // 导入 view-ui-plus 组件库中的相关组件
  import {Button, Message, PageHeader, Poptip} from "view-ui-plus";
  // 导入自定义的供应商表格组件
  import SupplierTable from "@/components/supplier/SupplierTable.vue";
  // 导入 Vue 的响应式 API 和生命周期钩子
  import {onMounted, ref} from "vue";
  // 导入 HTTP API 中的删除供应商和获取供应商列表的函数
  import {delSupplier, getSupplierList} from "@/http/api";
  // 导入 Vue Router 的钩子
  import {useRouter} from "vue-router";

  // 定义一个响应式的 loading 变量，用于控制加载状态
  const loading = ref(true);
  // 定义一个响应式的 supplierList 变量，用于存储供应商列表数据
  const supplierList = ref([]);
  // 定义一个响应式的 pageTotal 变量，用于存储总页数
  const pageTotal = ref(0);
  // 定义一个响应式的 pageSize 变量，用于控制每页显示的数量
  const pageSize = ref(20);

  // 在组件挂载时执行的钩子函数
  onMounted(() => {
    initSupplierList(1);
  });

  /**
   * 初始化供应商列表
   * @param pageNumber 当前页码
   */
  function initSupplierList(pageNumber) {
    getSupplierList(pageNumber, pageSize.value).then((data) => {
      supplierList.value = data.content;
      loading.value = false;
      pageTotal.value = data.totalElements;
    });
  }

  /**
   * 当每页显示数量改变时的处理函数
   * @param size 新的每页显示数量
   */
  function onPageSizeChange(size) {
    pageSize.value = size;
    initSupplierList(1);
  }

  // 获取 Vue Router 的 router 实例
  const router = useRouter();

  /**
   * 跳转到供应商编辑页面
   * @param supplierCode 供应商编码
   */
  function show(supplierCode) {
    router.push("/main/supplier/edit/" + supplierCode);
  }

  /**
   * 删除供应商
   * @param supplierCode 供应商编码
   */
  function remove(supplierCode) {
    delSupplier(supplierCode).then(() => {
      Message.info("删除成功,编号: " + supplierCode);
      initSupplierList(1);
    });
  }
</script>

<template>
  <!-- 供应商管理页面的头部 -->
  <PageHeader>
    <template #title>供应商管理</template>
    <template #action>
      <!-- 新增供应商的按钮 -->
      <Button type="primary" to="/main/supplier/edit/undefined">新增</Button>
    </template>
  </PageHeader>
  <!-- 供应商列表表格 -->
  <SupplierTable :loading="loading" :supplier-list="supplierList" v-slot="{row, index}">
    <!-- 查看供应商详情的按钮 -->
    <Button type="primary" size="small" style="margin-right: 5px" @click="show(row.supplierCode)">查看</Button>
    <!-- 删除供应商的按钮和确认对话框 -->
    <Poptip confirm transfer @on-ok="remove(row.supplierCode)">
      <Button type="error" size="small">删除</Button>
      <template #title>
        <span>确定要删除{{ row.name }}?</span>
      </template>
    </Poptip>
  </SupplierTable>
  <!-- 分页组件 -->
  <Page :total="pageTotal" :page-size="pageSize" @on-change="initSupplierList"
        @on-page-size-change="onPageSizeChange" show-sizer show-total/>
</template>

<style scoped>

</style>
```

### **表格组件**

- **SupplierTable.vue** 是表格组件，用于展示供应商列表，具体关联适配层的数据传输对象 `SupplierBasic`。

```vue
<script setup>
  // 导入 View UI Plus 组件库中的 Table 组件
  import {Table} from "view-ui-plus";
  // 导入 SupplierStatusSelect 组件，用于显示供应商状态
  import SupplierStatusSelect from "@/components/supplier/SupplierStatusSelect.vue";

  // 定义表格的列配置
  const columns = [
    // 序号列，使用索引类型，宽度为 80 像素
    {title: "序号", type: "index", width: 80},
    // 供应商编码列，直接显示数据中的 supplierCode 字段
    {
      title: "编码",
      key: "supplierCode",
    },
    // 供应商名称列，使用 name slot 自定义显示方式
    {
      title: "名称",
      slot: "name",
    },
    // 供应商状态列，使用 supplierStatus slot 自定义显示方式
    {
      title: "状态",
      slot: "supplierStatus"
    },
    // 操作列，居中对齐，宽度为 150 像素，使用 action slot 自定义显示方式
    {
      title: "操作",
      slot: "action",
      width: 150,
      align: "center",
    },
  ];

  // 定义组件接收的属性
  defineProps({
    // 加载状态，布尔类型
    loading: Boolean,
    // 供应商列表数据，数组类型，必须提供
    supplierList: {type: Array, required: true},
  });
</script>

<template>
  <!-- 使用 Table 组件显示数据 -->
  <Table :loading="loading" stripe :columns="columns" :data="supplierList">
    <!-- 定义 name slot，用于显示供应商名称 -->
    <template #name="{ row }">
      <strong>{{ row.name }}</strong>
    </template>
    <!-- 定义 supplierStatus slot，用于显示供应商状态 -->
    <template #supplierStatus="{ row }">
      <SupplierStatusSelect v-model="row.supplierStatus" comp-type="span"/>
    </template>
    <!-- 定义 action slot，用于显示操作按钮 -->
    <template #action="{ row, index }">
      <slot :row="row" :index="index"></slot>
    </template>
  </Table>
</template>

<style scoped>
  /* 此处添加组件的样式 */
</style>
```

## **编辑视图**

- **EditView.vue** 是编辑视图，用于创建或更新供应商信息。

```vue
<script setup>
  // 导入 view-ui-plus 组件库中的各个组件
  import {Button, ButtonGroup, Card, Col, FormItem, Icon, Message, Modal, PageHeader, Row} from "view-ui-plus";
  // 导入自定义的 SupplierForm 组件
  import SupplierForm from "@/components/supplier/SupplierForm.vue";
  // 导入 Vue Router 的钩子
  import {useRoute, useRouter} from "vue-router";
  // 导入 Vue 的生命周期钩子和 ref 函数
  import {onMounted, ref} from "vue";
  // 导入与供应商相关的 API 函数
  import {getSupplier, saveSupplier, updateSupplier} from "@/http/api";

  // 使用 useRoute 和 useRouter 获取当前路由信息和路由器实例
  const route = useRoute();
  const router = useRouter();
  // 使用 ref 创建响应式的供应商编码和供应商对象
  const supplierCode = ref(route.params.supplierCode);
  const supplier = ref({});

  // 在组件挂载时初始化供应商信息
  onMounted(() => {
    initSupplier();
  });

  /**
   * 初始化供应商信息
   * 通过供应商编码获取供应商详情，并赋值给 supplier
   */
  function initSupplier() {
    getSupplier(supplierCode.value).then((data) => {
      supplier.value = data;
    });
  }

  /**
   * 更新或保存供应商信息
   * 根据 supplierCode 是否存在决定是更新还是保存操作
   */
  function update() {
    if (!!supplier.value.supplierCode) {
      // 如果 supplierCode 存在，则更新供应商信息
      updateSupplier(supplier.value).then(() => {
        Message.info("更新成功,编号: " + supplierCode.value);
      });
    } else {
      // 如果 supplierCode 不存在，则保存新的供应商信息
      saveSupplier(supplier.value).then((id) => {
        supplierCode.value = id;
        Modal.confirm({
          title: '成功',
          content: `保存成功,编号: ${supplierCode.value}`,
          okText: '查看详情',
          cancelText: '继续新增',
          // 点击确定按钮后的操作
          onOk: () => {
            initSupplier();
            router.push(`/main/supplier/edit/${supplierCode.value}`);
          },
          // 点击取消按钮后的操作
          onCancel: () => {
            supplier.value = {};
            supplierCode.value = 'undefined';
            router.push('/main/supplier/edit/undefined');
          }
        })
      });
    }
  }

  /**
   * 重置供应商名称
   * 将供应商名称设置为空，用于表单重置
   */
  function handleReset() {
    supplier.value.name = null;
  }
</script>

<template>
  <!-- 页面头部组件，包含页面标题和返回按钮 -->
  <PageHeader title="供应商" back @on-back="router.push('/main/supplier/list')">
    <template #action>
      <!-- 如果 supplierCode 不是 'undefined'，显示联系人按钮 -->
      <ButtonGroup v-if="supplierCode !== 'undefined'">
        <Button type="primary" :to="`/main/supplier/contact/list/${supplierCode}`">联系人</Button>
      </ButtonGroup>
    </template>
  </PageHeader>
  <!-- 主要内容区域，包含供应商表单 -->
  <Row>
    <Col span="12" offset="6">
    <Card>
      <template #title>
        <Icon type="ios-book"/>
        询价详情
      </template>
      <!-- SupplierForm 组件，用于编辑供应商信息 -->
      <SupplierForm :supplier="supplier"
                    :disabled="supplier.supplierStatus !== 'POTENTIAL' && supplierCode !== 'undefined'">
        <FormItem>
          <!-- 保存和重置按钮 -->
          <Button type="primary" @click="update">保存</Button>
          <Button @click="handleReset()" style="margin-left: 8px">重置</Button>
        </FormItem>
      </SupplierForm>
    </Card>
    </Col>
  </Row>
</template>

<style scoped>

</style>
```

### **表单组件**

- **SupplierForm.vue** 是表单组件，用于展示、编辑供应商信息，具体关联适配层的数据对象 `SupplierDO`。

```vue
<script setup>
  // 导入 View UI Plus 组件库中的组件
  import {Col, Form, FormItem, Input, Row} from "view-ui-plus";
  // 导入供应商状态选择组件
  import SupplierStatusSelect from "@/components/supplier/SupplierStatusSelect.vue";

  // 定义组件的 props
  // supplier: 一个对象，包含供应商的信息，是必须的属性
  const props = defineProps({
    supplier: {type: Object, required: true}
  });
</script>

<template>
  <!-- 使用 Form 组件来布局供应商信息表单 -->
  <Form :model="supplier" label-position="top">
    <!-- 使用 Row 和 Col 组件来布局表单中的列 -->
    <Row>
      <Col span="8">
      <!-- 供应商编码输入框，禁止编辑 -->
      <FormItem label="编码">
        <Input v-model="supplier.supplierCode" disabled/>
      </FormItem>
      </Col>
      <Col span="16">
      <!-- 供应商名称输入框 -->
      <FormItem label="名称">
        <Input v-model="supplier.name"/>
      </FormItem>
      </Col>
    </Row>
    <Row>
      <Col span="8">
      <!-- 供应商状态选择框，禁止编辑 -->
      <FormItem label="状态">
        <SupplierStatusSelect v-model="supplier.supplierStatus" disabled/>
      </FormItem>
      </Col>
    </Row>
    <!-- 插槽，用于在组件使用时插入自定义内容 -->
    <slot></slot>
  </Form>
</template>

<style scoped>
  /* scoped 样式，仅影响当前组件 */
</style>
```

## **复合视图**

- **ListEditView.vue** 是复合视图，用于展示供应商的联系人列表和编辑供应商联系人信息。

```vue
<script setup>
// 导入供应商页面头部组件
import SupplierPageHeader from "@/components/supplier/SupplierPageHeader.vue";
// 导入View UI Plus的组件
import {Button, Card, Col, Icon, Message, Poptip, Row} from "view-ui-plus";
// 导入供应商联系人表单组件
import SupplierContactForm from "@/components/supplier/contact/SupplierContactForm.vue";
// 导入供应商联系人表格组件
import SupplierContactTable from "@/components/supplier/contact/SupplierContactTable.vue";
// 导入Vue的钩子和响应式引用
import {onMounted, ref} from "vue";
// 导入Vue Router的路由使用钩子
import {useRoute} from "vue-router";
// 导入与供应商联系人相关的API函数
import {
  delSupplierContact,
  getSupplier,
  getSupplierContact,
  getSupplierContactList,
  saveSupplierContact,
  updateSupplierContact
} from "@/http/api";

// 定义页面加载状态
const loading = ref(true);
// 定义联系人列表数据源
const contactList = ref([]);
// 定义当前操作的联系人数据源
const contact = ref({});
// 使用Vue Router获取当前路由
const route = useRoute();
// 提取路由参数中的供应商编码
const supplierCode = route.params.supplierCode;
// 定义供应商信息数据源
const supplier = ref({});

// 在组件挂载时执行初始化函数
onMounted(() => {
  initSupplier();
  initSupplierContactList();
});

/**
 * 初始化供应商信息
 */
function initSupplier() {
  getSupplier(supplierCode).then((data) => {
    supplier.value = data;
  });
}

/**
 * 初始化供应商联系人列表
 */
function initSupplierContactList() {
  getSupplierContactList(supplierCode).then((data) => {
    contactList.value = data;
    loading.value = false;
    contact.value = {};
  });
}

/**
 * 新增联系人
 */
function add() {
  contact.value = {};
}

/**
 * 更新或保存联系人信息
 * @param contact 联系人信息
 */
function updateContact(contact) {
  if (!!contact.id) {
    updateSupplierContact(supplierCode, contact).then(() => {
      Message.info("更新成功,ID: " + contact.id);
      initSupplierContactList();
    });
  } else {
    saveSupplierContact(supplierCode, contact).then((id) => {
      Message.info("新增成功,ID: " + id);
      initSupplierContactList();
    });
  }
}

/**
 * 选择联系人
 * @param row 表格行数据
 */
function select(row) {
  getSupplierContact(supplierCode, row.id).then((data) => {
    contact.value = data;
  });
}

/**
 * 删除联系人
 * @param id 联系人ID
 */
function remove(id) {
  delSupplierContact(supplierCode, id).then(() => {
    Message.info("删除成功,ID: " + id);
    initSupplierContactList();
  })
}
</script>

<template>
  <!-- 供应商页面头部 -->
  <SupplierPageHeader :supplier="supplier" :supplier-code="supplierCode"/>
  <!-- 供应商联系人详情卡片 -->
  <Row>
    <Col span="12" offset="6">
      <Card>
        <template #title>
          <Icon type="ios-book"/>
          供应商联系人详情
        </template>
        <!-- 供应商联系人表单 -->
        <SupplierContactForm :contact="contact" @update-event="updateContact" :disabled="false"/>
      </Card>
    </Col>
  </Row>
  <!-- 供应商联系人列表卡片 -->
  <Card>
    <template #title>
      <Icon type="md-list"/>
      供应商联系人列表
    </template>
    <template #extra>
      <!-- 新增联系人按钮 -->
      <Button type="primary" size="small" @click="add()">新增</Button>
    </template>
    <!-- 供应商联系人表格 -->
    <SupplierContactTable :loading="loading" :contact-list="contactList" @row-click-event="select">
      <template #tableAction="{row, index}">
        <!-- 删除联系人按钮 -->
        <Poptip confirm transfer @on-ok="remove(row.id)">
          <Button type="error" size="small">删除</Button>
          <template #title>
            <span>确定要删除{{ row.name }}?</span>
          </template>
        </Poptip>
      </template>
    </SupplierContactTable>
  </Card>
</template>

<style scoped>

</style>
```

### **表格组件-复合**

- **SupplierContactTable.vue** 是表格组件，用于展示供应商列表，具体关联适配层的数据传输对象 `SupplierContactBasic`。
```vue
<script setup>
// 导入 View UI Plus 的 Table 组件
import { Table } from "view-ui-plus";

// 定义表格的列配置
const columns = [
  // 序号列，使用索引类型，宽度为 80 像素
  { title: "序号", type: "index", width: 80 },
  // 名称列，键为 name，开启 tooltip 以支持长文本溢出时的提示，居中对齐
  {
    title: "名称",
    key: "name",
    tooltip: true,
    align: "center"
  },
  // 电话列，键为 phone，宽度为 180 像素
  {
    title: "电话",
    key: "phone",
    width: 180
  },
  // 操作列，使用 slot 方式自定义内容，宽度为 150 像素，居中对齐
  {
    title: "操作",
    slot: "action",
    width: 150,
    align: "center",
  },
];

// 定义组件的 props，包括 loading 状态和联系人列表 contactList
defineProps({
  loading: Boolean,
  contactList: { type: Object, required: true },
});
// 定义组件的 emits，用于触发行双击事件
defineEmits(["rowClickEvent"]);
</script>

<template>
  <Table max-height="220" :loading="loading" stripe :columns="columns" :data="contactList"
         @on-row-dblclick="$emit('rowClickEvent', $event)">
    <template #action="{ row, index }">
      <slot name="tableAction" :row="row" :index="index"></slot>
    </template>
  </Table>
</template>

<style scoped>
/* 以下是样式代码，当前未定义任何样式 */
</style>
```

### **表单组件-复合**

- **SupplierContactForm.vue** 是表单组件，用于展示、编辑供应商信息，具体关联适配层的数据对象 `SupplierContactDO`。
```vue
<script setup>
// 导入 view-ui-plus 组件库中的相关组件
import {Button, Col, Form, FormItem, Input, Row} from "view-ui-plus";

// 定义组件的 props，这里指定了 contact 属性为 Object 类型，并且是必须的
const props = defineProps({
  contact: {type: Object, required: true}
});

// 定义 emit，用于触发自定义事件
const emit = defineEmits(["updateEvent"]);

/**
 * 重置联系人信息
 * 这个函数将 contact 对象的 name 和 phone 属性重置为 null
 */
function handleReset() {
  props.contact.name = null;
  props.contact.phone = null;
}
</script>

<template>
  <!-- 使用 Form 组件来布局联系人信息输入表单 -->
  <Form :model="contact" label-position="top">
    <Row>
      <Col span="12">
        <!-- 名称输入框 -->
        <FormItem label="名称">
          <Input v-model="contact.name"/>
        </FormItem>
      </Col>
      <Col span="12">
        <!-- 电话输入框 -->
        <FormItem label="电话">
          <Input v-model="contact.phone"/>
        </FormItem>
      </Col>
    </Row>
    <FormItem>
      <!-- 保存按钮，点击时触发 updateEvent 自定义事件，传递 contact 对象 -->
      <Button type="primary" @click="$emit('updateEvent', props.contact)">保存</Button>
      <!-- 重置按钮，点击时调用 handleReset 函数 -->
      <Button @click="handleReset()" style="margin-left: 8px">重置</Button>
    </FormItem>
  </Form>
</template>

<style scoped>
/* 这里可以添加 scoped 的样式来定制组件的外观 */
</style>
```

## **共享组件**

- **SupplierStatusSelect.vue** 是共享组件，用于选择供应商状态。

```vue

<script setup>
  import {Option, Select} from "view-ui-plus";

  const model = defineModel()
  defineProps({
    compType: {type: String, default: 'select'}
  });
</script>

<template>
  <Select v-if="compType === 'select'" v-model="model">
    <Option value="POTENTIAL">潜在</Option>
    <Option value="INTRODUCING">引入中</Option>
    <Option value="QUALIFIED">合格</Option>
    <Option value="EXITED">已退出</Option>
  </Select>
  <div v-else>
    <span v-if="model === 'POTENTIAL'">潜在</span>
    <span v-else-if="model === 'INTRODUCING'">引入中</span>
    <span v-else-if="model === 'QUALIFIED'">合格</span>
    <span v-else-if="model === 'EXITED'">已退出</span>
  </div>
</template>

<style scoped>

</style>
```

- **SupplierSelect.vue** 是共享组件，用于选择供应商。

```vue

<script setup>
  import {Option, Select} from "view-ui-plus";
  import {onMounted, ref} from "vue";
  import {getThinSupplierList} from "@/http/api";

  const code = defineModel('code');
  const name = defineModel('name');

  const supplierList = ref([])

  onMounted(() => {
    getThinSupplierList().then(data => {
      supplierList.value = data;
    })
  })

  function selectSupplier(selection) {
    name.value = selection.label;
  }
</script>

<template>
  <Select v-model="code" @on-select="selectSupplier" label-in-value filterable>
    <Option v-for="item in supplierList" :key="item.code" :value="item.code">{{ item.name }}</Option>
  </Select>
</template>

<style scoped>

</style>
```

## **axios请求**

> 添加axios请求到@/http/api，具体关联适配层的API `SupplierRest`

```javascript
// ------ 供应商 ------
// 获取供应商列表
export const getSupplierList = (pageNumber, pageSize) =>
    service.get("/v1/supplier/page/basic?pageNumber=".concat(pageNumber - 1).concat("&pageSize=").concat(pageSize));
// 获取精简供应商列表
export const getThinSupplierList = () =>
    service.get("/v1/supplier/list/code/name");
// 获取供应商详情
export const getSupplier = (supplierCode) =>
    service.get("/v1/supplier/".concat(supplierCode));
// 创建供应商
export const saveSupplier = (supplier) =>
    service.post("/v1/supplier/create", supplier);
// 更新供应商信息
export const updateSupplier = (supplier) =>
    service.post("/v1/supplier/update", supplier);
// 删除供应商
export const delSupplier = (supplierCode) =>
    service.post("/v1/supplier/remove/".concat(supplierCode));

// ------ 供应商联系人 ------
// 获取供应商联系人列表
export const getSupplierContactList = (supplierCode) =>
    service.get("/v1/supplier/".concat(supplierCode).concat("/contact/list"));
// 获取供应商联系人列表
export const getThinContactList = (supplierCode) =>
    service.get("/v1/supplier/".concat(supplierCode).concat("/contact/list/name/phone"));
// 获取供应商联系人详情
export const getSupplierContact = (supplierCode, supplierContactId) =>
    service.get(
        "/v1/supplier/".concat(supplierCode).concat("/contact/").concat(supplierContactId)
    );
// 新增供应商联系人
export const saveSupplierContact = (supplierCode, product) =>
    service.post(
        "/v1/supplier/".concat(supplierCode).concat("/contact/add"),
        product
    );
// 更新供应商联系人信息
export const updateSupplierContact = (supplierCode, product) =>
    service.post(
        "/v1/supplier/".concat(supplierCode).concat("/contact/update"),
        product
    );
// 删除供应商联系人
export const delSupplierContact = (supplierCode, supplierContactId) =>
    service.post(
        "/v1/supplier/"
            .concat(supplierCode)
            .concat("/contact/remove/")
            .concat(supplierContactId)
    );
```

## **路由配置**

> 添加路由，使用[Vue Router](https://router.vuejs.org/zh/guide/)

```javascript
// ------ 供应商 ------
{
    path: "supplier/list",
        name
:
    "supplier",
        component
:
    () => import("@/views/supplier/ListView.vue"),
}
,
{
    path: "supplier/edit/:supplierCode",
        component
:
    () => import("@/views/supplier/EditView.vue"),
}
,
{
    path: "supplier/contact/list/:supplierCode",
        component
:
    () => import("@/views/supplier/contact/ListEditView.vue"),
}
```
